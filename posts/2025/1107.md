---
title: HLS 视频流播放故障深度排查总结报告
tags: [开发]
categories: [开发教程]
date: 2025-11-07
description: 跨域安全策略（CORS）导致的资源拦截与 Cloudflare R2 环境下的解决方案
---

# HLS 视频流播放故障深度排查总结报告

**报告日期：** 2025 年 11 月 7 日
**故障现象：** HLS 播放器无法播放视频流，网络请求返回 HTTP **200 OK** 状态码，但 **m3u8 主播放列表文件大小显示为 0B**。
**环境描述：**

* **资源域名：** `https://raw.20100907.xyz` (托管在 Cloudflare R2 对象存储)

* **播放器域名：** `https://chiyu.it` (前端应用运行环境)

* **目标文件路径：** `/pic/end/video/1.m3u8`

## 一、初始故障现象与排查路径的修正：揭示“0B 陷阱”

我最初观察到的故障现象极具误导性：一个成功的 `200 OK` 响应，却伴随着内容长度为零（0B）的结果。这种状态在网络排查中是一个经典的“陷阱”，因为它模糊了网络传输层和应用安全层之间的界限。

### 1.1 初期假设与排除法

最初的排查路径围绕两个主要假设展开，这是处理此类网络资源加载失败时的标准流程：

1. **服务端/中间件错误（Body 缺失）：** 怀疑 Cloudflare R2、可能存在的 Cloudflare Worker 脚本或 CDN 边缘缓存层在文件传输过程中出现了错误。例如，Worker 脚本可能在未正确克隆响应的情况下消费了响应体（Body），导致返回给客户端的 Response 实例为空；或者 CDN 缓存节点由于配置错误，仅缓存了头部信息而丢失了内容。

2. **文件本身问题：** 怀疑 `1.m3u8` 文件在 R2 存储桶中的类型配置问题

### 1.2 关键证据的引入与排查重点转移

发现了至关重要的响应头信息：**服务器返回的响应头中包含正确的 `Content-Length: 938` 和 `Content-Type: application/x-mpegurl`。**

这一证据是排查过程中的转折点，它彻底排除了文件内容丢失或文件本身为空的假设。服务器明确承诺将发送 938 字节的数据，且内容类型正确。这表明问题并非出在服务器**如何生成响应头**，而在于客户端**如何接收和处理响应体**。排查重点因此迅速转向前端播放环境或**浏览器安全策略**，特别是跨域访问时的行为。

## 二、关键证据与问题锁定：CORS 策略拦截的深层机理

为了绕过 HLS 播放器库的复杂逻辑，建议使用原生 `Fetch` 或 `XMLHttpRequest` 进行测试，结果捕获到了**决定性的跨域安全错误**。

| **错误信息 (控制台日志)** | **详细技术含义** | 
 | ----- | ----- | 
| Access to XMLHttpRequest at '...' from origin 'https://chiyu.it' has been blocked by CORS policy: | 浏览器检测到请求来源域名与目标资源域名不一致，根据同源策略（Same-Origin Policy，SOP）触发了 CORS 安全检查，这是所有现代浏览器强制执行的基石。 | 
| No 'Access-Control-Allow-Origin' header is present on the requested resource. | 这是 CORS 检查失败的直接原因。资源服务器 (`raw.20100907.xyz`) 未在 HTTP 响应头中包含 `Access-Control-Allow-Origin` (A-C-A-O) 头部，无法验证是否允许 `chiyu.it` 域名访问。 | 
| GET ... net::ERR_FAILED 200 (OK) | 这是一个典型的误导信号。`200 OK` 证明网络连接成功，Header 已达客户端，但**浏览器安全沙箱**拦截了后续的 Body 数据流，阻止其进入 JavaScript 可访问的内存空间。 | 

### 2.1 根本原因分析：浏览器安全模型的执行与同源策略

最终确认，故障的根本原因并非服务器传输错误，而是**CORS（跨域资源共享）策略阻止**。这一阻止基于 Web 的核心安全原则——同源策略（SOP）。SOP 要求只有当协议、域名和端口都相同时，JavaScript 才能访问资源的详细内容。

1. **预检请求 (Preflight) 的必要性：** HLS 播放器（底层 XHR/Fetch）发出的请求通常不是“简单请求”（例如，它们可能包含自定义头部、使用非 `GET/POST` 方法、或使用非标准 `Content-Type`）。对于非简单请求，浏览器会**强制先发送一个 `OPTIONS` 预检请求**。如果预检请求的响应中缺少正确的 CORS 头部，浏览器会立即中止后续的 `GET` 请求，这是一种“立即终止”的机制。即使主 `GET` 请求成功发出，如果其响应头部仍不包含 A-C-A-O，也会被拦截。

2. **数据隔离与 0B 现象的精确解释：** 在 A-C-A-O 头部缺失的情况下，浏览器出于对用户数据安全的保护，严格执行同源策略。虽然底层的网络堆栈接收到了 938 字节的数据（这也是 `Content-Length` 正确的原因），但浏览器安全模型将其隔离，**阻止 JavaScript 线程（HLS 播放器）访问该数据**。对于前端代码而言，数据表现为**不可读的 0 字节**，最终导致播放器启动逻辑失败。

## 三、解决方案与实施建议：Cloudflare 环境下的多路径配置

解决此问题的核心是确保 `raw.20100907.xyz` 返回的响应头中，包含允许 `https://chiyu.it` 访问的正确 CORS 头部。在 Cloudflare 生态中，有多种方法可以实现。

### 3.1 最佳实践：R2 CORS 策略配置详解与安全考量

推荐在 Cloudflare R2 存储桶中直接配置 CORS 策略（XML 或 JSON 格式），这是最符合资源管理逻辑的方式。

* **AllowedOrigins：** 必须包含 `https://chiyu.it`。**安全警示：** 应避免使用通配符 `*`，因为它允许任何网站将您的 R2 资源嵌入其页面并读取其内容。出于安全考虑，应始终**明确列出**所有允许的来源域名（白名单机制）。

* **AllowedMethods：** 必须配置为 `GET` 或你的请求方法。

* **AllowedHeaders & ExposeHeaders：** 建议将 `AllowedHeaders` 设置为 `*` 或明确列出如 `Authorization` 等自定义头部。`ExposeHeaders` 字段用于允许前端脚本读取特定的响应头（如 `X-Custom-Header`），但对于基础 HLS 播放，确保 `Content-Length` 和 `Content-Type` 能被浏览器访问即可。

![Cloudflare R2](https://raw.20100907.xyz/pic/2025/1107/02.webp)

### 3.2 备选方案：Cloudflare 响应标头转换规则的优势与限制

如果 R2 存储桶被用于多用途或出于管理需求不便修改其原生 CORS 策略，可以使用 Cloudflare 的 **响应标头转换规则 (Response Headers Transform)** 在 CDN 边缘层强制添加该头部。

* **技术优势：** 此规则在 Cloudflare 的全球 CDN 边缘执行，实现了业务逻辑与存储配置的分离。它能够在不修改 R2 自身策略的情况下，在响应到达用户之前动态注入 A-C-A-O 头部。

* **实施考量：** 必须确保该规则的**筛选条件**足够精确。它应仅应用于 HLS 相关的媒体文件（例如：URL 路径包含 `/video/` 且文件扩展名为 `.m3u8` 或 `.ts`），以避免不必要地将 CORS 头部添加到图片、CSS 或其他静态资源，这可能对缓存或其他安全策略产生副作用。

![Cloudflare 响应标头转换规则](https://raw.20100907.xyz/pic/2025/1107/01.webp)

### 3.3 Worker 脚本中的注意事项（代码级解决方案）

如果 `raw.20100907.xyz` 域名前有 Cloudflare Worker 代理 R2，则必须在 Worker 脚本中处理 CORS：

1. **响应克隆：** 确保从 R2 获取的原始响应 `r2Response` 在返回前被克隆，或者使用 `new Response()` 构造函数传入 `r2Response.body`。

2. **头部注入：** 使用 `newResponse.headers.set('Access-Control-Allow-Origin', '...')` 方法，在代码中动态注入头部信息。

## 四、总结与后续验证：确保 HLS 完整性

本次故障是一次典型的安全策略配置错误，与数据传输速率、文件损坏或服务器离线无关。一旦正确的 CORS 头部被添加到 `raw.20100907.xyz` 的响应中，浏览器将解除安全限制，HLS 播放器即可顺利读取 m3u8 文件内容（938字节）并开始加载后续的分片，从而恢复正常播放。

**修复后的关键验证步骤：**

1. **验证 m3u8 主文件：** 修复 CORS 配置后，再次通过 DevTools 检查 `1.m3u8` 的响应头，确保 `Access-Control-Allow-Origin: https://chiyu.it` 头部已成功添加，并且网络面板中的文件大小不再显示 `0B`。

2. **验证 .ts 分片：** HLS 播放流程是连续的，依赖于后续所有 `.ts` 分片文件（Media Segments）。这些分片也属于跨域资源，**必须确保它们也返回了正确的 `Content-Type: video/mp2t` 和相同的 CORS 头部**。如果分片文件的 CORS 配置遗漏，m3u8 文件加载成功后，视频仍会因分片加载失败（表现为长时间缓冲或中断）而无法播放。

3. **清除缓存：** 部署新规则后，务必清除 Cloudflare 的缓存和浏览器的本地缓存，以确保用户获取的是带有新的、正确头部信息的资源。